# üìö MiGallery - Mode d‚Äôemploi

Vous trouverez ici tout ce qu‚Äôil y a √† savoir sur l‚Äôutilisation de MiGallery, galerie de photos et vid√©os en ligne de l‚Äôassociation MiTV, d√©velopp√©e par Jolan Boudin et Gabriel Dupont.

## Sommaire

### Version Utilisateur

1. [Premi√®re visite](#1-premi√®re-visite)
2. [CGU et Politique de confidentialit√©](#2-cgu-et-politique-de-confidentialit√©)
3. [Biom√©trie](#3-biom√©trie)
4. [Albums](#4-albums)
5. [Mes Photos](#5-mes-photos)
6. [Photos CV](#6-photos-cv)
7. [Param√®tres](#7-param√®tres)

### [R√©serv√© aux membres de MiTV] Version MiTViste

1. [Premi√®re visite](#1-premi√®re-visite-1)
2. [Gestion des Albums](#2-gestion-des-albums)
3. [Gestion de la Corbeille](#3-gestion-de-la-corbeille)
4. [Photos CV](#version-mitviste-4-photos-cv)

### Documentation Technique

1. [Fonctionnement Global](#fonctionnement-global)

---

## Version Utilisateur

## 1. Premi√®re visite

Lorsque vous vous rendez √† l‚Äôadresse [https://gallery.mitv.fr/](https://gallery.mitv.fr/), il y a deux cas de figure :

- Ou bien vous venez du portail ICM, dans ce cas vous √™tes d√©j√† identifi√©.
- Ou bien non, il faudra vous identifier.

Dans les deux cas de figure, vous devez cliquer sur **‚ÄòSe connecter‚Äô**.

Dans le deuxi√®me cas, vous serez donc redirig√© vers le CAS (Service d'authentification centralis√©e de Mines Saint-√âtienne) pour vous identifier.

### Reste √† configurer votre compte

Vous devriez maintenant avoir une pop-up : cliquez sur **‚ÄòConfigurer mon profil‚Äô** afin de continuer.

> **Attention !** Si vous renseignez mal votre promotion, vous n‚Äôacc√®derez pas aux albums MiGallery correspondant √† votre passage √† Mines Saint-√âtienne ! Si jamais cela devait arriver, veuillez nous contacter √† l‚Äôadresse mail [bureau@mitv.fr](mailto:bureau@mitv.fr).

### 2. CGU et Politique de confidentialit√©

Avant de continuer la configuration de votre compte, il est essentiel que vous preniez connaissance de nos **CGU et Politique de confidentialit√©**.

### 3. Biom√©trie

Pour mettre en place la reconnaissance faciale, il suffira de se rendre dans **‚ÄòParam√®tres‚Äô** en cliquant sur l‚Äôic√¥ne correspondante √† cet onglet.

Vous pourrez ainsi **‚ÄòUtiliser la webcam‚Äô** ou **‚ÄòImporter une photo‚Äô** de vous-m√™me pour initier un traitement algorithmique qui retrouvera votre visage sur nos photos MiTV.

> **NB :** Conform√©ment √† notre politique de confidentialit√©, les photos issues de l‚Äôinitialisation de votre reconnaissance faciale ne sont stock√©es dans nos serveurs que pour **24h**. Pass√© ce d√©lai, elles seront supprim√©es d√©finitivement.

Vous pouvez d√©sormais acc√©der √† toutes les fonctionnalit√©s de MiGallery !

### 4. Albums

Accessible en cliquant sur l‚Äôic√¥ne correspondante, cet onglet regroupe les albums de photos MiTV correspondant √† votre passage √† l‚ÄôEMSE. Vous n‚Äôavez pas les m√™mes acc√®s compar√© aux anciennes (ou nouvelles) promotions, dans un souci de respect de la ‚Äòvie priv√©e‚Äô d‚Äôalumnis n‚Äôayant pas ou pas encore souscrit √† nos CGU et Politique de confidentialit√©.

Vous pouvez effectuer une recherche sur le nom de l‚Äôalbum dans la barre de recherche et au passage de la souris, vous avez la possibilit√© de **‚ÄòT√©l√©charger‚Äô** l‚Äôenti√®ret√© de l‚Äôalbum.

Une fois dans un album, vous pouvez admirer les photos. Au passage de la souris, vous pouvez ou bien **‚ÄòS√©lectionner‚Äô** ou **‚ÄòT√©l√©charger‚Äô** individuellement les photos et au clic, acc√©der √† une interface de visualisation individualis√©e, photo par photo.

Dans cette derni√®re, vous pouvez **‚ÄòZoomer‚Äô**, **‚ÄòT√©l√©charger‚Äô** et quitter le mode via les ic√¥nes correspondantes. Vous pouvez aussi vous d√©placer dans l‚Äôalbum via les fl√®ches √† droite et √† gauche de la photo regard√©e.

Vous pouvez aussi **‚ÄòS√©lectionner‚Äô** plusieurs photos et **‚ÄòT√©l√©charger‚Äô** la s√©lection via le menu de s√©lection. Vous pouvez aussi **‚ÄòT√©l√©charger‚Äô** tout l‚Äôalbum ou le **‚ÄòPartager‚Äô** via les ic√¥nes correspondantes.

### 5. Mes Photos

Ici, vous retrouverez les photos que la reconnaissance faciale vous attribue. Il faut consid√©rer cet onglet comme un album de vous finalement !

Ainsi vous retrouverez les m√™mes fonctionnalit√©s que pour un album ‚Äòclassique‚Äô, comme d√©velopp√© ci-dessus. Vous avez une possibilit√© suppl√©mentaire : **mettre en favoris** une ou plusieurs photos, au passage de la souris et en cliquant sur l‚Äôic√¥ne c≈ìur associ√©e √† la photo regard√©e. Vous pouvez aussi mettre en favori une photo en la regardant depuis la visualisation individualis√©e.

Une fois mise en favoris, la photo sera d√©plac√©e au d√©but de ‚ÄòMes Photos‚Äô dans la cat√©gorie **‚ÄòFavoris‚Äô**.

> **NB :** Depuis ‚ÄòMes Photos‚Äô, vous avez la possibilit√© de modifier votre photo de profil : au clic sur votre photo de profil actuelle, un menu de s√©lection sous forme de pop-up appara√Ætra et vous pourrez s√©lectionner la photo de vous que vous pr√©f√©rez parmi toutes celles de ‚ÄòMes Photos‚Äô. Cette fonctionnalit√© est accessible aussi depuis les ‚ÄòParam√®tres‚Äô.

### 6. Photos CV

Dans cet onglet, vous retrouverez l‚Äôenti√®ret√© de vos ‚Äòphotos CV‚Äô, r√©alis√©es par MiTV : de m√™me que pour un album de ‚Äòphotos CV‚Äô donc pour plus d‚Äôinfo c‚Äôest ici !

### 7. Param√®tres

Dans l‚Äôonglet ‚ÄòParam√®tres‚Äô, vous pouvez modifier vos param√®tres d‚Äôutilisateurs comme bon vous semble.

#### A. Photo de profil

Ici, pareil √† l‚Äôonglet ‚ÄòMes Photos‚Äô, en cliquant sur **‚ÄòChoisir sa photo‚Äô** vous aurez acc√®s √† un menu de s√©lection de photo de profil r√©sultant de la reconnaissance faciale.

#### B. Apparence

En cliquant sur **‚ÄòMode Clair‚Äô** ou **‚ÄòMode Sombre‚Äô**, vous passerez de la version 1 √† la version 2 de MiGallery.

#### C. Reconnaissance faciale

Dans cette section de l‚Äôonglet ‚ÄòParam√®tres‚Äô, vous pourrez (r√©)activer la reconnaissance faciale de MiGallery. Il suffit d‚Äôutiliser sa webcam ou d‚Äôimporter une photo de votre visage seul. Pour plus d‚Äôinfo, lisez nos CGU et Politique de confidentialit√© ainsi que la section [Premi√®re visite](#1-premi√®re-visite).

#### D. Partage de vos photos (interne √† MiGallery)

Dans cette section, vous pouvez donner acc√®s √† d‚Äôautres utilisateurs l‚Äôacc√®s √† vos photos issues de ‚ÄòMes Photos‚Äô. Cette fonctionnalit√© est √† destination des associations pour la cr√©ation d‚Äôaffiches avec les membres des associations. Le partage de vos photos n‚Äôengage que vous.

### E. ‚ÄòZone de Danger‚Äô

Dans cette ultime partie de ‚ÄòParam√®tres‚Äô vous pouvez, comme cela est explicitement √©crit, **‚ÄòDissocier mon visage‚Äô** c‚Äôest-√†-dire supprimer toute reconnaissance faciale relative √† votre visage et √† votre compte. Cette action supprime aussi l‚Äôacc√®s √† vos photos de ‚ÄòMes Photos‚Äô aux personnes auxquelles vous auriez autoris√© leurs acc√®s.

Vous pouvez aussi **‚ÄòSupprimer [votre] compte‚Äô**. Ainsi m√™me identifi√© par le CAS, vous ne serez d√©finitivement plus authentifi√© par MiGallery. **Cette action est irr√©versible.**

---

## Version MiTViste

## 1. Premi√®re visite

Le d√©roulement de la premi√®re connexion d‚Äôun compte MiTViste est identique √† celui d‚Äôun compte ‚Äòclassique‚Äô d‚Äôutilisateur. La marche √† suivre est [ici](#1-premi√®re-visite). La version MiTViste diff√®re sur la gestion des Albums, l‚Äôacc√®s √† la Corbeille, et des photos CV.

> **NB :** Comme indiqu√© ci-dessus, vous avez ‚Äòplus‚Äô de vision que les utilisateurs normaux : vous avez acc√®s aux albums gris√©s, invisibles pour les utilisateurs non autoris√©s.

### 2. Gestion des Albums

Dans la section ‚ÄòAlbums‚Äô vous avez les droits en tant que membre MiTV, d‚Äôapporter vos modifications √† cette section. En clair vous pouvez :

- Cr√©er/supprimer un album
- Importer de nouvelles photos
- Supprimer les photos d‚Äôun album
- Modifier les acc√®s

### A. Cr√©ation/Suppression d‚Äôun album

Pour cr√©er un nouvel album, il suffit de cliquer sur le bouton de cr√©ation.

Vous serez alors amen√© sur la fen√™tre o√π vous pourrez remplir les caract√©ristiques de l‚Äôalbum :

- **Nom** (obligatoire)
- **Date** (optionnel)
- **Lieu** (optionnel)
- **Visibilit√©**
- Les **Tags** (Promotions ICM et autres)
- Les **Utilisateurs autoris√©s**

> **NB :** √Ä la cr√©ation de l‚Äôalbum, par d√©faut il sera accessible par toutes les promotions, veillez √† bien rendre cela impossible en supprimant les Tags ‚Äòpromos‚Äô, le temps d‚Äôimporter la totalit√© de vos fichiers.

Vous pouvez directement **‚Äò√âditer‚Äô** les caract√©ristiques de l‚Äôalbum ou le supprimer avec les ic√¥nes correspondantes. Les ic√¥nes ‚ÄòPartager‚Äô et ‚ÄòT√©l√©charger‚Äô sont identiques √† la version Utilisateurs.

Pour **supprimer** un album, dans l‚Äôonglet ‚ÄòAlbums‚Äô vous avez la possibilit√© au passage de la souris sur l‚Äôic√¥ne correspondante, de soit T√©l√©charger ou Supprimer l‚Äôalbum en question. Une pop-up appara√Ætra, √† noter que cette action est **d√©finitive**.

#### B. Importer vos photos/vid√©os

Comme d√©sign√© par l‚Äôinterface, vous pouvez importer un fichier image de type `.png`, `.jpeg`, `.HEIC`, `.gif` mais aussi des vid√©os en `.avi`, `.mp4`, `.m4v`, `.mov`, `.mpg`, `.mpeg`, `.wmv`, etc‚Ä¶ Tout autre format de fichier ne sera pas reconnu par l‚Äôinterface.

Aussi, en tant que MiTViste mais surtout en tant qu'utilisateur de MiGallery vous √™tes soumis √† nos CGU et Politique de confidentialit√© sur toutes les images, vid√©os ou autres que vous importez.

> **NB :** Lors de l‚Äôimportation, il se peut que certaines de vos nouvelles photos aient le m√™me nom, un algorithme de suppression de doublon est mis en place sur la galerie, veillez √† bien v√©rifier vos photos avant de les importer !

Les ic√¥nes de vos nouveaux fichiers ne s‚Äôafficheront pas directement, pour v√©rifier ‚Äò√† vue‚Äô, il faut recharger la page pour mettre √† jour l‚Äôensemble des ic√¥nes.

#### C. S√©lection

Au passage de la souris sur les ic√¥nes, vous aurez la possibilit√© de **S√©lectionner** (en haut √† gauche de l‚Äôic√¥ne), **T√©l√©charger** (en haut √† droite) ou de **D√©placer dans la Corbeille** (en bas √† droite).

Si vous s√©lectionnez une image, le menu de gestion appara√Ætra. Cela vous permet de :

- ‚ÄòTout s√©lectionner‚Äô
- ‚ÄòTout d√©s√©lectionner‚Äô
- ‚ÄòT√©l√©charger‚Äô (la s√©lection active)
- ‚ÄòRetirer‚Äô (la s√©lection active) -> Retirer de l'album sans supprimer (Uniquement dans un album)
- ‚ÄòSupprimer‚Äô (la s√©lection active) -> D√©placer dans la Corbeille

√Ä noter que les photos que vous ‚ÄòSupprimez‚Äô sont bien d√©plac√©es dans la ‚ÄòCorbeille‚Äô (suppression globale de Immich). Celles que vous ‚ÄòRetirez‚Äô sont simplement enlev√©es de l'album mais restent dans la biblioth√®que globale.

### D. Gestion des acc√®s √† l‚Äôalbum

Peut-√™tre la premi√®re chose √† faire lors de la cr√©ation d‚Äôun album mais surtout la derni√®re et la plus importante. La gestion des acc√®s √† un album est le c≈ìur de notre politique de confidentialit√©. Veillez √† bien respecter les directives de MiTV concernant tel ou tel album et de bien v√©rifier les param√®tres d‚Äôacc√®s √† l‚Äôalbum avant de fermer votre onglet MiGallery.

La modification des acc√®s se fait conjointement avec les modifications des param√®tres de l‚Äôalbum, en cliquant sur l‚Äôic√¥ne **‚Äò√âditer‚Äô**.

La **visibilit√©** est le param√®tre clef de cette section. Vous avez trois choix :

1. **Priv√©** : acc√®s r√©serv√© aux Tags/Utilisateurs autoris√©s (g√©n√©ralement un album de Soir√©e ou autres event ICM).
2. **Authentifi√©** (tous les utilisateurs connect√©s) : toutes les personnes pouvant se connecter par le CAS sont capables de voir l‚Äôalbum. C‚Äôest un album public r√©serv√© aux utilisateurs connect√©s.
3. **Acc√®s par lien** : v√©ritablement public, toute personne m√™me non authentifi√©e a acc√®s par lien √† l‚Äôalbum. Prenez vos pr√©cautions !

> **NB :** Visibilit√© ne veut pas dire Visible ! Cette case √† cocher g√®re la publication dans l‚Äôonglet Albums pour les utilisateurs sans grade.

Les **Tags** sont g√©n√©r√©s par l‚Äôadmin. Ce sont g√©n√©ralement les promotions ICM (jusqu‚Äô√† 4 promotions en simultan√© sauf exceptions). Vous pouvez les renseigner dans la section associ√©e, en veillant √† bien s√©parer par une virgule ‚Äò,‚Äô les diff√©rents Tags.

Les **Utilisateurs autoris√©s** sont exactement les personnes (en dehors des MiTVistes et admins) qui ont acc√®s √† l‚Äôalbum. De m√™me, veillez √† bien s√©parer par une ‚Äò,‚Äô les `id_user`.

### 3. Gestion de la Corbeille

Supposons que je veuille supprimer une s√©lection de fichiers d‚Äôun album. Une pop-up s‚Äôaffiche pour confirmer la mise en place dans la Corbeille. Une fois que le bouton ‚ÄòMettre √† la corbeille‚Äô est cliqu√©, une notification en haut √† droite de la fen√™tre web appara√Æt.

Maintenant en cliquant sur l‚Äôonglet **‚ÄòCorbeille‚Äô**, on retrouve mon fichier supprim√©. Au passage de la souris sur son ic√¥ne, on a toujours la s√©lection, la suppression d√©finitive cette fois, et aussi la restauration. **‚ÄòRestaurer‚Äô** renvoie le fichier dans son album d‚Äôorigine.

En cliquant sur la suppression d√©finitive, une nouvelle pop-up appara√Æt.

> **NB :** L‚Äôint√©gralit√© des photos de la biom√©trie se retrouve dans la Corbeille, les photos ne sont pas stock√©es plus de 24h, comme selon nos CGU et Politique de confidentialit√©.

### 4. Photos CV

Exactement comme pour la version Utilisateur, seulement comme pour un album, vous pouvez importer de nouvelles photos CV.

---

## Fonctionnement Global

Cette section d√©taille l'architecture technique et le fonctionnement interne de MiGallery. Elle est destin√©e aux d√©veloppeurs et aux administrateurs souhaitant comprendre les rouages de l'application.

## 1. Philosophie et Architecture

MiGallery a √©t√© con√ßue comme une **interface l√©g√®re et s√©curis√©e** (fa√ßade) devant une instance **Immich**. L'objectif est de fournir une exp√©rience utilisateur simplifi√©e et adapt√©e aux besoins de l'association MiTV (gestion des promotions, confidentialit√©, biom√©trie), tout en d√©l√©guant la gestion lourde des m√©dias (stockage, transcodage, ML) √† Immich.

#### Stack Technique

- **Frontend & Backend** : [SvelteKit](https://kit.svelte.dev/)
  - **SSR (Server-Side Rendering)** : Pour une meilleure performance initiale et le SEO.
  - **Routing** : Bas√© sur le syst√®me de fichiers (`src/routes`).
  - **API** : Endpoints internes (`src/routes/api`) pour s√©curiser les appels vers Immich.
- **Runtime** : [Bun](https://bun.sh/) (compatible Node.js)
  - Utilis√© pour sa rapidit√© d'ex√©cution et son gestionnaire de paquets int√©gr√©.
- **Base de Donn√©es** : **SQLite**
  - Fichier local (`data/migallery.db`).
  - Stocke : Utilisateurs, Permissions, M√©tadonn√©es √©tendues des albums (visibilit√©, tags), Logs.
  - Acc√®s via `better-sqlite3` (abstraction dans `src/lib/db/database.ts`).
- **Moteur M√©dia** : [Immich](https://immich.app/)
  - Stockage physique des fichiers.
  - G√©n√©ration des miniatures.
  - Reconnaissance faciale (Machine Learning).

---

### 2. Structure du Projet et Relations

Voici comment les diff√©rents dossiers interagissent entre eux :

#### A. Routes (`src/routes`)

C'est le point d'entr√©e de l'application.

- **`+layout.svelte`** : Le squelette global. Il contient la barre de navigation (`MobileNav.svelte` sur mobile) et g√®re l'√©tat global de l'authentification.
- **`+page.svelte`** : La page d'accueil.
- **`albums/`** :
  - **`+page.svelte`** : Liste tous les albums. Charge les donn√©es via `+page.server.ts` qui filtre les albums selon les droits de l'utilisateur (`src/lib/albums.ts`).
  - **`[id]/+page.svelte`** : Vue d√©taill√©e d'un album.
    - Utilise `PhotosGrid.svelte` pour afficher les images.
    - G√®re le streaming des assets via `PhotosState` (`src/lib/photos.svelte.ts`).
- **`api/`** : Le backend interne.
  - **`immich/[...path]/+server.ts`** : **Le c≈ìur du proxy**. Toutes les requ√™tes vers Immich passent par ici. Ce fichier : 1. V√©rifie l'authentification de l'utilisateur. 2. V√©rifie les permissions sp√©cifiques (ex: a-t-il le droit de voir cet album ?). 3. Transmet la requ√™te √† Immich avec la cl√© API admin. 4. Renvoie la r√©ponse (ou le flux d'image) au client.

#### B. Composants (`src/lib/components`)

Les briques visuelles r√©utilisables.

- **`PhotosGrid.svelte`** :
  - **R√¥le** : Affiche une grille de photos (album ou r√©sultats de recherche).
  - **D√©pendances** : `PhotoCard.svelte` (carte individuelle), `PhotoModal.svelte` (lightbox).
  - **Logique** : Re√ßoit un objet `PhotosState` qui contient la liste des photos.
- **`PhotoModal.svelte`** :
  - **R√¥le** : Affichage plein √©cran d'une photo.
  - **Fonctionnalit√©s** : Zoom, t√©l√©chargement, navigation clavier (fl√®ches), suppression (si admin).
- **`UploadZone.svelte`** :
  - **R√¥le** : Zone de drag & drop pour l'upload.
  - **Logique** : Utilise `src/lib/album-operations.ts` pour envoyer les fichiers par chunks.

#### C. Logique M√©tier (`src/lib`)

- **`photos.svelte.ts` (`PhotosState`)** :
  - Une classe r√©active (Svelte 5 runes) qui g√®re l'√©tat d'une liste de photos.
  - G√®re le chargement progressif (streaming NDJSON) pour afficher les photos d√®s qu'elles sont trouv√©es, sans attendre la fin de la requ√™te.
- **`immich/`** :
  - Contient les fonctions d'aide pour interagir avec Immich (`albums.ts`, `download.ts`).
- **`db/`** :
  - `database.ts` : Singleton de connexion √† SQLite.
  - `schema.sql` : D√©finition des tables.

---

### 3. Flux de Donn√©es D√©taill√©

#### Exemple : Affichage d'un Album Priv√©

1. **Navigation** : L'utilisateur va sur `/albums/123`.
2. **Server Load (`albums/[id]/+page.server.ts`)** :
   - R√©cup√®re l'album `123` dans la DB SQLite.
   - V√©rifie via `checkAlbumAccess` (`src/lib/albums.ts`) si l'utilisateur (session CAS) a le droit de voir cet album (v√©rification des tags promo, liste d'utilisateurs autoris√©s).
   - Si OK, renvoie les m√©tadonn√©es de base au client.
3. **Client Mount (`albums/[id]/+page.svelte`)** :
   - Initialise `PhotosState`.
   - Appelle `photosState.loadAlbumWithStreaming`.
4. **API Call (Streaming)** :
   - Le client appelle `/api/immich/albums/123/assets`.
   - **Proxy (`api/immich/[...path]`)** :
     - Intercepte la requ√™te.
     - V√©rifie √† nouveau les droits d'acc√®s en DB.
     - Interroge Immich pour avoir la liste des assets.
     - Renvoie les assets un par un (NDJSON) au client.
5. **Rendu (`PhotosGrid.svelte`)** :
   - √Ä chaque asset re√ßu, `PhotosState` met √† jour sa liste.
   - Svelte met √† jour le DOM pour afficher la nouvelle `PhotoCard`.
6. **Chargement d'Image** :
   - `<img src="/api/immich/assets/xyz/thumbnail">`
   - Le proxy v√©rifie que l'utilisateur a acc√®s √† l'album contenant l'asset `xyz`.
   - Si OK, il pipe le flux d'image depuis Immich vers le navigateur.

---

### 4. Sch√©ma des Relations (Simplifi√©)

```mermaid
graph TD
    User[Utilisateur] -->|HTTPS| SvelteKit[MiGallery (SvelteKit)]

    subgraph "MiGallery Server"
        Auth[Auth (CAS)]
        Proxy[API Proxy (/api/immich/*)]
        DB[(SQLite Local)]
        Logic[Logique M√©tier (src/lib)]
    end

    subgraph "External"
        Immich[Immich Server]
        Storage[Disque Dur / NAS]
    end

    SvelteKit --> Auth
    SvelteKit --> Proxy

    Proxy -->|V√©rifie Droits| DB
    Proxy -->|API Key Admin| Immich

    Logic --> DB

    Immich --> Storage
```

### 5. Points d'Attention pour le D√©veloppement

- **S√©curit√© avant tout** : Ne jamais faire confiance au client. Toujours rev√©rifier les droits c√¥t√© serveur (dans `+page.server.ts` et dans le proxy API).
- **Performance** : Utiliser le streaming (NDJSON) pour les listes de photos. Ne pas charger 5000 photos d'un coup en m√©moire.
- **Immich est "b√™te"** : Pour MiGallery, Immich est juste un stockage. La logique de "qui a le droit de voir quoi" est enti√®rement dans MiGallery (SQLite). Ne pas essayer de g√©rer les permissions utilisateurs dans Immich directement.
