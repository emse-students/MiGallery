name: Release

on:
 push:
  tags:
   - 'v*.*.*'
   - 'v*.*.*-*'

jobs:
 test:
  name: Run Tests
  runs-on: ubuntu-latest
  strategy:
   matrix:
    node-version: [18, 20, 22]
  steps:
   - name: Checkout
     uses: actions/checkout@v6

   - name: Setup Node.js ${{ matrix.node-version }}
     uses: actions/setup-node@v6
     with:
      node-version: ${{ matrix.node-version }}

   - name: Setup Bun
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: latest

   - name: Install dependencies
     run: bun install

   - name: Type check
     run: bun run check

   - name: Lint
     run: bun run lint

   - name: Build
     run: bun run build

   - name: Setup test database
     run: |
      mkdir -p data
      bun run db:init || echo "Database already exists or init failed"

   - name: Create .env file for tests
     run: |
      cat > .env << EOF
      ENABLE_DEV_ROUTES=true
      COOKIE_SECRET=ci-test-secret-not-for-production-use
      DATABASE_PATH=./data/migallery.db
      IMMICH_BASE_URL=
      IMMICH_API_KEY=
      AUTH_TRUSTED_HOST=true
      EOF

   - name: Run tests
     run: bun run test
     env:
      API_BASE_URL: http://localhost:3000

 release:
  name: Create Release
  runs-on: ubuntu-latest
  needs: test
  permissions:
   contents: write
  steps:
   - name: Checkout
     uses: actions/checkout@v6
     with:
      fetch-depth: 0

   - name: Setup Bun
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: latest

   - name: Install dependencies
     run: bun install

   - name: Sync version with tag
     run: |
      VERSION=${GITHUB_REF_NAME#v}
      echo "Setting version to $VERSION"
      npm version $VERSION --no-git-tag-version --allow-same-version

   - name: Build
     run: bun run build

   - name: Package application
     run: bun run package

   - name: Generate changelog
     id: changelog
     run: |
      # RÃ©cupÃ©rer le tag prÃ©cÃ©dent
      PREVIOUS_TAG=$(git tag --sort=-creatordate | grep -v "$(git describe --tags)" | head -n 1)
      CURRENT_TAG=$(git describe --tags)

      echo "ðŸ“ Generating changelog from ${PREVIOUS_TAG} to ${CURRENT_TAG}"

      # GÃ©nÃ©rer le changelog
      if [ -z "$PREVIOUS_TAG" ]; then
        # Premier tag, prendre tous les commits
        CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
      else
        # Commits depuis le dernier tag
        CHANGELOG=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges)
      fi

      # CrÃ©er le contenu de la release
      cat > release_notes.md << EOF
      ## ðŸš€ What's Changed

      ${CHANGELOG}

      ## ðŸ“¦ Installation

      \`\`\`bash
      # TÃ©lÃ©charger et extraire le package
      tar -xzf migallery-package.tgz
      cd package

      # Installer les dÃ©pendances
      bun install --production

      # Configurer l'environnement
      cp .env.example .env
      # Ã‰diter .env avec vos paramÃ¨tres

      # Initialiser la base de donnÃ©es
      bun run db:init

      # DÃ©marrer l'application
      bun run build/index.js
      \`\`\`

      **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}
      EOF

      echo "changelog_file=release_notes.md" >> $GITHUB_OUTPUT

   - name: Create GitHub Release
     uses: softprops/action-gh-release@v2
     with:
      body_path: release_notes.md
      files: |
       build/artifacts/*.tgz
       build/artifacts/*.tar.gz
      draft: false
      prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
      generate_release_notes: false
     env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

   - name: Upload build artifacts
     uses: actions/upload-artifact@v7
     with:
      name: release-artifacts-${{ github.ref_name }}
      path: |
       build/artifacts/*.tgz
       build/artifacts/*.tar.gz
       release_notes.md
      retention-days: 90
