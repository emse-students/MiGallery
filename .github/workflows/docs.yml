name: Documentation

on:
 push:
  branches:
   - main
  paths:
   - 'docs/**'
   - 'src/lib/docs/**'
   - 'README.md'
   - '.github/workflows/docs.yml'

# Permissions n√©cessaires pour publier sur GitHub Pages
permissions:
 contents: read
 pages: write
 id-token: write

# Ne permettre qu'un seul d√©ploiement √† la fois
concurrency:
 group: 'pages'
 cancel-in-progress: false

jobs:
 build:
  name: Build Documentation
  runs-on: ubuntu-latest
  steps:
   - name: Checkout
     uses: actions/checkout@v6

   - name: Setup Node.js
     uses: actions/setup-node@v6
     with:
      node-version: '20'

   - name: Create documentation site
     run: |
      mkdir -p _site

      # Cr√©er la page d'accueil
      cat > _site/index.html << 'EOF'
      <!DOCTYPE html>
      <html lang="fr">
      <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>MiGallery - Documentation</title>
       <style>
        :root {
         --primary: #667eea;
         --secondary: #764ba2;
         --text: #333;
         --bg: #f6f8fa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
         line-height: 1.6;
         color: var(--text);
         background: var(--bg);
         min-height: 100vh;
         display: flex;
         flex-direction: column;
        }
        .header {
         background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
         color: white;
         padding: 4rem 2rem;
         text-align: center;
         margin-bottom: 3rem;
         box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 3rem; margin-bottom: 1rem; font-weight: 800; letter-spacing: -1px; }
        .header p { font-size: 1.2rem; opacity: 0.9; max-width: 600px; margin: 0 auto; }
        .container {
         max-width: 1200px;
         margin: 0 auto;
         padding: 0 2rem;
         width: 100%;
         flex: 1;
        }
        .section-title {
         font-size: 1.8rem;
         color: var(--secondary);
         margin-bottom: 1.5rem;
         border-bottom: 2px solid #e2e8f0;
         padding-bottom: 0.5rem;
         display: flex;
         align-items: center;
         gap: 0.5rem;
        }
        .grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
         gap: 2rem;
         margin-bottom: 4rem;
        }
        .card {
         background: white;
         border-radius: 12px;
         padding: 2rem;
         box-shadow: 0 4px 6px rgba(0,0,0,0.05);
         transition: transform 0.2s, box-shadow 0.2s;
         text-decoration: none;
         color: inherit;
         border: 1px solid #e2e8f0;
         display: flex;
         flex-direction: column;
         height: 100%;
        }
        .card:hover {
         transform: translateY(-5px);
         box-shadow: 0 10px 20px rgba(0,0,0,0.1);
         border-color: var(--primary);
        }
        .card h3 {
         color: var(--primary);
         font-size: 1.4rem;
         margin-bottom: 0.75rem;
        }
        .card p {
         color: #666;
         flex-grow: 1;
         font-size: 0.95rem;
        }
        .footer {
         text-align: center;
         padding: 3rem;
         color: #666;
         border-top: 1px solid #e2e8f0;
         background: white;
         margin-top: auto;
        }
       </style>
      </head>
      <body>
       <div class="header">
        <h1>üì∏ MiGallery Docs</h1>
        <p>Documentation officielle de l'application de galerie photo de MiTV</p>
       </div>

       <div class="container">
        <h2 class="section-title">üìö Manuel Utilisateur</h2>
        <div class="grid">
         <a href="tutorial.html" class="card">
          <h3>üéì Mode d'emploi</h3>
          <p>Guide complet pour les utilisateurs et les membres MiTV : albums, photos, biom√©trie, gestion des droits...</p>
         </a>
         <a href="README.html" class="card">
          <h3>üìñ √Ä propos</h3>
          <p>Pr√©sentation g√©n√©rale du projet, installation et informations essentielles.</p>
         </a>
        </div>

        <h2 class="section-title">üõ† Documentation Technique</h2>
        <div class="grid">
         <a href="COMPONENTS.html" class="card">
          <h3>üß© Composants</h3>
          <p>Documentation des composants Svelte et de l'interface utilisateur.</p>
         </a>
         <a href="STYLES.html" class="card">
          <h3>üé® Styles</h3>
          <p>Guide des styles, th√®mes et design system de l'application.</p>
         </a>
         <a href="SCRIPTS.html" class="card">
          <h3>üìú Scripts</h3>
          <p>Documentation des scripts utilitaires et outils de maintenance.</p>
         </a>
         <a href="NAVBAR_ACCESS_MATRIX.html" class="card">
          <h3>üß≠ Navigation</h3>
          <p>Matrice des droits d'acc√®s et structure de la navigation.</p>
         </a>
        </div>
       </div>

       <div class="footer">
        <p>MiGallery - D√©velopp√© avec ‚ù§Ô∏è par MiTV</p>
        <p style="margin-top: 0.5rem;"><a href="https://github.com/emse-students/MiGallery" style="color: var(--primary); text-decoration: none;">üì¶ Voir le code source sur GitHub</a></p>
       </div>
      </body>
      </html>
      EOF

   - name: Convert Markdown to HTML
     run: |
      npm install -g marked

      # Fonction pour convertir un fichier Markdown en HTML
      convert_md_to_html() {
       local input_file="$1"
       local output_file="_site/$(basename "${input_file%.md}.html")"
       local title=$(basename "${input_file%.md}")

       cat > "$output_file" << EOF
      <!DOCTYPE html>
      <html lang="fr">
      <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>${title} - MiGallery Documentation</title>
       <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
       <style>
        body {
         margin: 0;
         padding: 0;
         background: #f6f8fa;
        }
        .container {
         max-width: 980px;
         margin: 0 auto;
         padding: 2rem;
        }
        .header {
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
         padding: 2rem;
         margin: -2rem -2rem 2rem -2rem;
         border-radius: 8px 8px 0 0;
        }
        .header a {
         color: white;
         text-decoration: none;
         opacity: 0.9;
        }
        .header a:hover { opacity: 1; }
        .markdown-body {
         background: white;
         padding: 2rem;
         border-radius: 8px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
       </style>
      </head>
      <body>
       <div class="container">
        <div class="header">
         <a href="index.html">‚Üê Retour √† l'accueil</a>
         <h1>${title}</h1>
        </div>
        <div class="markdown-body">
      EOF

       marked "$input_file" >> "$output_file"

       cat >> "$output_file" << EOF
        </div>
       </div>
      </body>
      </html>
      EOF
      }

      # Convertir tous les fichiers Markdown
      find docs -name "*.md" -type f | while read -r file; do
       convert_md_to_html "$file"
      done

      find src/lib/docs -name "*.md" -type f | while read -r file; do
       convert_md_to_html "$file"
      done

      # Convertir le README principal
      if [ -f "README.md" ]; then
       convert_md_to_html "README.md"
      fi

   - name: Setup Pages
     uses: actions/configure-pages@v5

   - name: Upload artifact
     uses: actions/upload-pages-artifact@v4
     with:
      path: '_site'

 deploy:
  name: Deploy to GitHub Pages
  environment:
   name: github-pages
   url: ${{ steps.deployment.outputs.page_url }}
  runs-on: ubuntu-latest
  needs: build
  steps:
   - name: Deploy to GitHub Pages
     id: deployment
     uses: actions/deploy-pages@v4
